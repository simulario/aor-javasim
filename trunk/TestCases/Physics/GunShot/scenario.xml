<?xml version="1.0" encoding="UTF-8"?>

<SimulationScenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://aor-simulation.org ../../../AORSL/AORSL_0-8-4.xsd"
    xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://aor-simulation.org" version="0.8.4"
    scenarioName="GunShot">
    <SimulationParameters simulationSteps="3000" timeUnit="ms" stepTimeDelay="5"/>

    <SimulationModel modelName="GunShot" modelTitle="Gun Shot with Gravitation Effect">
        <documentation>
            <dc:description>Emulate a gun shot by following Physics lows and using
                gravitation.</dc:description>
            <dc:creator>Mircea Diaconescu</dc:creator>
        </documentation>

        <SpaceModel geometry="Euclidean" spatialDistanceUnit="m">
            <TwoDimensional_LateralView xMax="5000" yMax="3000"/>
        </SpaceModel>

        <Globals>
            <GlobalVariable name="gravitation" dataType="Float"/>
            <GlobalVariable name="PI" dataType="Float"/>
            <GlobalVariable name="shotAngle" dataType="Float"/>
            <GlobalVariable name="startVelocity" dataType="Float"/>
            <GlobalVariable name="startX" dataType="Float"/>
            <GlobalVariable name="startY" dataType="Float"/>
        </Globals>


        <EntityTypes>
            <ExogenousEventType name="Shut" periodicity="1"/>
            <ExogenousEventType name="Step" periodicity="1"/>
            <PhysicalObjectType name="Bullet"/>
            <PhysicalObjectType name="Gun"/>

            <PhysicalObjectType name="HorizontalBar"/>
            <PhysicalObjectType name="HorizontalSlider"/>

            <PhysicalObjectType name="VerticalBar"/>
            <PhysicalObjectType name="VerticalSlider"/>
        </EntityTypes>

        <EnvironmentRules>
            <EnvironmentRule name="ShutBulletRule">
                <WHEN eventType="Shut" eventVariable="shutEvent"/>
                <IF language="Java">shutEvent.getOccurrenceTime() == 1</IF>
                <THEN>
                    <UPDATE-ENV>
                        <Create>
                            <PhysicalObject type="Bullet" id="2">
                                <Slot property="x">
                                    <ValueExpr language="Java">Global.getStartX()</ValueExpr>
                                </Slot>
                                <Slot property="y">
                                    <ValueExpr language="Java">Global.getStartY()</ValueExpr>
                                </Slot>
                                <Slot property="vx" value="100"/>
                                <Slot property="vy" value="150"/>
                                <Slot property="width" value="113"/>
                                <Slot property="height" value="112"/>
                            </PhysicalObject>
                        </Create>
                    </UPDATE-ENV>
                </THEN>
            </EnvironmentRule>

            <EnvironmentRule name="MoveBulletRule">
                <WHEN eventType="Step" eventVariable="stepEvent"/>
                <FOR objectVariable="bullet" objectType="Bullet" objectIdRef="2"/>
                <FOR objectVariable="hSlider" objectType="HorizontalSlider" objectIdRef="101"/>
                <FOR objectVariable="vSlider" objectType="VerticalSlider" objectIdRef="201"/>
                <FOR dataVariable="currentTime" dataType="Float">
                    <ValueExpr language="Java">
                        <![CDATA[
                            stepEvent.getOccurrenceTime()/25.0f
                        ]]>
                    </ValueExpr>
                </FOR>
                <DO>
                    <UPDATE-ENV>
                        <UpdateObject objectVariable="bullet">                        
                            <Slot property="x">
                                <ValueExpr language="Java">
                                    <![CDATA[
                                         Global.getStartX() + Global.getStartVelocity() * java.lang.Math.cos(Global.getShotAngle()) * currentTime
                                    ]]>
                                </ValueExpr>
                            </Slot>
                            <Slot property="y">
                                <ValueExpr language="Java">
                                    <![CDATA[
                                        Global.getStartY() + Global.getStartVelocity() * java.lang.Math.sin(Global.getShotAngle()) * currentTime
                                        - (Global.getGravitation() / 2.0f) * currentTime * currentTime
                                    ]]>
                                </ValueExpr>
                            </Slot>
                            <Slot property="rotZ">
                                <ValueExpr language="Java">
                                    <![CDATA[
                                    0
                                    ]]>
                                </ValueExpr>
                            </Slot>
                        </UpdateObject>

                        <UpdateObject objectVariable="hSlider">
                            <Slot property="x">
                                <ValueExpr language="Java">
                                    <![CDATA[
                                        bullet.getX()
                                    ]]>
                                </ValueExpr>
                            </Slot>
                        </UpdateObject>

                        <UpdateObject objectVariable="vSlider">
                            <Slot property="y">
                                <ValueExpr language="Java">
                                    <![CDATA[
                                        bullet.getY()
                                    ]]>
                                </ValueExpr>
                            </Slot>
                        </UpdateObject>
                    </UPDATE-ENV>
                </DO>
            </EnvironmentRule>

            <EnvironmentRule name="BulletFallsToGroundRule">
                <WHEN eventType="Step" eventVariable="stepEvent"/>
                <FOR objectVariable="bullet" objectType="Bullet" objectIdRef="2"/>
                <IF language="Java"><![CDATA[bullet.getY() <= 0.5]]></IF>
                <THEN>
                    <SCHEDULE-EVT>
                        <CausedEventExpr eventType="StopSimulationEvent"/>
                    </SCHEDULE-EVT>
                </THEN>
            </EnvironmentRule>
        </EnvironmentRules>

    </SimulationModel>

    <InitialState>
        <PhysicalObject type="Gun" id="1" x="400" y="350" width="645" height="750"/>

        <PhysicalObject type="HorizontalBar" id="100" x="2500" y="2800" z="1" width="5000"
            height="50"/>
        <PhysicalObject type="HorizontalSlider" id="101" y="2775" z="2" width="25" height="100">
            <Slot property="x">
                <ValueExpr language="Java">
                    <![CDATA[
                        Global.getStartX()
                    ]]>
                </ValueExpr>
            </Slot>
        </PhysicalObject>

        <PhysicalObject type="VerticalBar" id="200" x="4800" z="1" y="1500" width="50" height="3000"/>
        <PhysicalObject type="VerticalSlider" id="201" x="4850" z="2" width="150" height="25">
            <Slot property="y">
                <ValueExpr language="Java">
                    <![CDATA[
                        Global.getStartY()
                    ]]>
                </ValueExpr>
            </Slot>
        </PhysicalObject>

        <ExogenousEvent type="Shut" occurrenceTime="1"/>
        <ExogenousEvent type="Step" occurrenceTime="1"/>

        <GlobalVariable name="startVelocity" value="170"/>
        <GlobalVariable name="startX" value="520"/>
        <GlobalVariable name="startY" value="700"/>
        <GlobalVariable name="gravitation" value="9.81"/>
        <GlobalVariable name="PI">
            <ValueExpr language="Java">java.lang.Math.PI</ValueExpr>
        </GlobalVariable>
        <GlobalVariable name="shotAngle">
            <ValueExpr language="Java">java.lang.Math.PI/4</ValueExpr>
        </GlobalVariable>
    </InitialState>

    <UserInterface>
        <AnimationUI>
            <Views>
                <SpaceView canvasColor="grey">
                    <TwoDimensionalSpaceView2D backgroundColor="lightgrey"/>
                </SpaceView>

                <PhysicalObjectView physicalObjectIdRef="1" physicalObjectType="Gun">
                    <PhysicalShape2D>
                        <Rectangle texture="colt45.png"/>
                    </PhysicalShape2D>
                </PhysicalObjectView>

                <PhysicalObjectView physicalObjectIdRef="2" physicalObjectType="Bullet">
                    <PhysicalShape2D>
                        <Rectangle texture="bullet.png"/>
                    </PhysicalShape2D>
                </PhysicalObjectView>

                <PhysicalObjectView physicalObjectType="HorizontalSlider">
                    <PhysicalShape2D>
                        <Rectangle fill="red"/>
                    </PhysicalShape2D>
                    <DisplayInfo property="x" content="m"/>
                </PhysicalObjectView>

                <PhysicalObjectView physicalObjectType="HorizontalBar">
                    <PhysicalShape2D>
                        <Rectangle fill="white" stroke="blue" strokeWidth="1"/>
                    </PhysicalShape2D>
                </PhysicalObjectView>

                <PhysicalObjectView physicalObjectType="VerticalSlider">
                    <PhysicalShape2D>
                        <Rectangle fill="red"/>
                    </PhysicalShape2D>
                    <DisplayInfo property="y" content="m"/>
                </PhysicalObjectView>

                <PhysicalObjectView physicalObjectType="VerticalBar">
                    <PhysicalShape2D>
                        <Rectangle fill="white" stroke="blue" strokeWidth="1"/>
                    </PhysicalShape2D>
                </PhysicalObjectView>
            </Views>
        </AnimationUI>

    </UserInterface>
</SimulationScenario>
