<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="prettyprint.xsl"?>

<SimulationScenario version="0.8.4" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://aor-simulation.org ../../../AORSL/AORSL_0-8-4.xsd"
	xmlns="http://aor-simulation.org" xmlns:aors="http://aor-simulation.org"
	xmlns:dc="http://purl.org/dc/elements/1.1/" 
	scenarioName="Gold_Food_Economy"
	scenarioTitle="Gold Food Economy"
	simulationManagerDirectory="../../..">

	<SimulationParameters simulationSteps="4320" timeUnit="h"  stepTimeDelay="0"/>
	<SimulationModel modelName="Gold_Food_Economy">
		<documentation>
			<dc:modified>20100306</dc:modified>
			<dc:source>"A computational market model based on individual action", by Ken Steiglitz, Michael L. Honig and Leonard M. Cohen, 1996. URL: http://www.cs.princeton.edu/~ken/scott.pdf</dc:source>
			<aors:description xmlns="http://www.w3.org/1999/xhtml">The "Gold Food Economy" is an example of an agent-based simulation of a relatively basic economy that does not directly model a real economy, but attempts to explain the macroeconomy through simulation of a minimal economy. It is one of the simplest models wherein zero-intelligence agents produce, consume and trade in an economy with only two goods: gold and food. The model simulates the actions of independent "worker" agents, each with his own inventory and skills (at producing food and gold), interacting through an auction market agent that establishes a commonly accepted transaction price. Workers must consume a unit of food every period, and each worker tries to maintain a minimum inventory of food to guarantee consumption. For the system to survive the production of food must be greater than the total food consumption per period, but this leads to a surplus of food in the economy. The market allows agents to sell their surplus food for gold that can be used to purchase food in the same market later on. Agents more skilled in the production of gold might decide to mine gold and trade it for food at every period.</aors:description>
		</documentation>
		
		<Statistics>
			<Variable name="PriceFood" dataType="Float">	
				<Source>
					<ObjectProperty property="marketPrice" objectType="Market" objectIdRef="2"/>
				</Source>
			</Variable>
			<Variable name="BuyOffersFood" dataType="Float">	
				<Source>
					<ObjectProperty property="buyVolume" objectType="Market" objectIdRef="2"/>
				</Source>
			</Variable>
			<Variable name="SellOffersFood" dataType="Float">	
				<Source>
					<ObjectProperty property="sellVolume" objectType="Market" objectIdRef="2"/>
				</Source>
			</Variable>
			<Variable name="PriceLabor" dataType="Float">	
				<Source>
					<ObjectProperty property="marketPrice" objectType="Market" objectIdRef="3"/>
				</Source>
			</Variable>
			<Variable name="BuyOffersLabor" dataType="Float">	
				<Source>
					<ObjectProperty property="buyVolume" objectType="Market" objectIdRef="3"/>
				</Source>
			</Variable>
			<Variable name="SellOffersLabor" dataType="Float">	
				<Source>
					<ObjectProperty property="sellVolume" objectType="Market" objectIdRef="3"/>
				</Source>
			</Variable>
		</Statistics>
		
		<DataTypes>
			<!--====================================-->
			<ComplexDataType name="AssetsList">
				<!--====================================-->
				<ClassDef language="Java"><![CDATA[
					private java.util.ArrayList<aors.util.economics.Quantity> assets = new java.util.ArrayList<aors.util.economics.Quantity>();			
				 
					public AssetsList() {}			                       
					
					public Double addAsset(Double quantity, String name, String unit) {
				
					  aors.util.economics.ContinuousQuantityType assetType = new aors.util.economics.ContinuousQuantityType(name, unit);
					  aors.util.economics.ContinuousQuantity asset = new aors.util.economics.ContinuousQuantity(quantity, assetType);
					  assets.add(asset);	
					  //System.out.println("Array is: "+assets);
					  return quantity;
					}
					
					public void add(Double quantity, String name, String unit) {
				
					  aors.util.economics.ContinuousQuantityType assetType = new aors.util.economics.ContinuousQuantityType(name, unit);
					  aors.util.economics.ContinuousQuantity asset = new aors.util.economics.ContinuousQuantity(quantity, assetType);
					  assets.add(asset);	
					  //System.out.println("Array is: "+assets);
					}
					
					public aors.util.economics.Quantity getAsset(String name){
						int i;
						for(i=0; i < assets.size(); i++){
							if(!assets.get(i).isDiscrete()){
								if(((aors.util.economics.ContinuousQuantity)assets.get(i)).getContinuousQuantityType().getName().equals(name)){
									break;
								}
							}
						}
						return assets.get(i);
					}
	  			]]></ClassDef>
			</ComplexDataType>
			<!--====================================-->
			<ComplexDataType name="Offer">
				<!--====================================-->
				<Attribute type="String" name="product"/>
				<Attribute type="String" name="currency"/>
				<Attribute type="Float" name="price"/>
				<Attribute type="Float" name="Quantity"/>
				<Attribute type="Boolean" name="buy"/>
				<Attribute type="Integer" name="AgentID"/>
			</ComplexDataType>
			<!--====================================-->
			<ComplexDataType name="OfferList">
				<!--====================================-->
				<ClassDef language="Java"><![CDATA[
					private java.util.ArrayList<Offer> offers = new java.util.ArrayList<Offer>();
					
					public OfferList(){;
					}
					
					public Boolean isEmpty(){
						return offers.isEmpty();
					}
					
					public java.util.ArrayList<Offer> getOffers(){
						return this.offers;
					}
					public void print(){
						for(int i=0;i<offers.size();i++){
							System.out.println(offers.get(i).getPrice());
						}
					}
				]]></ClassDef>
			</ComplexDataType>
		</DataTypes>
		
		<EntityTypes>
			<!--====================================-->
			<MessageType name="StartOfDay_msg">
				<!--====================================-->
				<Attribute name="price" type="Float"/>
				<Attribute name="marketType" type="String" />
			</MessageType>
			<!--====================================-->
			<MessageType name="Act_msg" />
			<!--====================================-->
			<MessageType name="BuyFood_msg">
				<!--====================================-->
				<ComplexDataProperty name="OfferList" type="OfferList"/>
			</MessageType>
			<!--====================================-->
			<MessageType name="SellFood_msg">
				<!--====================================-->
				<ComplexDataProperty name="OfferList" type="OfferList"/>
			</MessageType>
			<!--====================================-->
			<MessageType name="SellLabor_msg">
				<!--====================================-->
				<ComplexDataProperty name="OfferList" type="OfferList"/>
			</MessageType>
			<!--====================================-->
			<MessageType name="BuyLabor_msg">
				<!--====================================-->
				<ComplexDataProperty name="OfferList" type="OfferList"/>
			</MessageType>
			<!--====================================-->
			<MessageType name="Clear_msg" >
				<!--====================================-->
				<ComplexDataProperty name="TransactionList" type="OfferList"/>
			</MessageType>
			<!--====================================-->
			<MessageType name="Transaction_msg" >
				<!--====================================-->
				<ComplexDataProperty name="offer" type="Offer"/>
			</MessageType>
			<!--=======================================================-->
			<ExogenousEventType name="StartOfDay" periodicity="15" />
			<!--=======================================================-->
			<ExogenousEventType name="EachDayAt8AM" periodicity="15" />
			<!--=======================================================-->
			<ExogenousEventType name="EachDayAt11AM" periodicity="15" />
			<ExogenousEventType name="Init" />
			<!-- ============================================ -->
			<AgentType name="EconomicAgent">
				<ComplexDataProperty name="assets" type="AssetsList" />
				<Attribute type="Float" name="LABOR_ALLOWANCE" initialValue="1.0"/>
				<!-- ============================================ -->
				<!--<ComplexDataProperty name="assets" type="Quantity" upperMultiplicity="unbounded" />-->
			</AgentType>
			<!-- ============================================ -->
			<AgentType name="Person" superType="EconomicAgent">
				<!-- ============================================ -->
				<!-- <ComplexDataProperty name="assets" type="AssetsList" /> -->
				<Attribute type="Float" name="EAT_AMOUNT" initialValue="1.0"/>
				<Attribute type="Float" name="TARGET_FOOD_STOCK" initialValue="33.0"/>
				<Attribute type="Float" name="TARGET_MONEY_STOCK" initialValue="60.0"/>
				<Attribute type="Float" name="RANDOM_FACTOR" initialValue="0.01"/>
				<Attribute type="Float" name="lastFoodPrice"/>
				<Attribute type="Float" name="lastLaborPrice"/>
				<Attribute type="Float" name="foodStock"/>
				<Attribute type="Float" name="goldAmount"/>
				<Attribute type="Boolean" name="owner"/>
				<Attribute type="String" name="test"/>
				<ComplexDataProperty name="BuyList" type="OfferList"/>
				<ComplexDataProperty name="SellList" type="OfferList"/>
				
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="buyFood" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the buyoffers and adds them to the buyofferlist</dc:description>
					</documentation>
					<Parameter name="agentID" type="long"/>
					<Body language="Java"><![CDATA[
						//System.out.println("Food: " + getAssets().getAsset("Food").getQuantity() + " ||||| ID:   " + agentID);
						//System.out.println("Money: " + getAssets().getAsset("Money").getQuantity() + " ||||| ID:   " + agentID);
						getBuyList().getOffers().clear();
						final double quantum = getEAT_AMOUNT() * 1.0;
			          	double purse = getAssets().getAsset("Money").getQuantity();
			          	for (double x = getAssets().getAsset("Food").getQuantity(); x <= 1.5 * getTARGET_FOOD_STOCK(); x += quantum) {
			            	if(x == 0.0){
			            		x = .00000000001;
			            	} 
			            	double mod = .1*Math.pow(getTARGET_FOOD_STOCK()/x, .2) +.90/*5*/+Random.uniform(0.0, 1.0)*getRANDOM_FACTOR();
			            	double price = mod*getLastFoodPrice();
			            	price = Math.min(price, purse);
			            	if (price <= 0.0){
			            		break;
			            	}
			              	purse -= quantum*price;
			            	if(purse < 0.0){
			            		break;
			            	}
			            	Offer o = new Offer();
			            	//prüfen ob überhaupt soviel abgehoben werden kann eventl. esrt im Markt
			            	o.setProduct("Food");
			            	o.setCurrency("Money");
			            	o.setQuantity(quantum);
			            	o.setPrice(price);
			            	o.setBuy(true);
			            	o.setAgentID(agentID);
			            	getBuyList().getOffers().add(o);
			          	}
			          	//System.out.println("buyFood: " + getBuyList().getOffers().size());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="sellFood" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the selloffers and adds them to the sellofferlist</dc:description>
					</documentation>
					<Parameter name="agentID" type="long"/>
					<Body language="Java"><![CDATA[
						getSellList().getOffers().clear();
						if(getAssets().getAsset("Food").getQuantity() > 1.5*getTARGET_FOOD_STOCK()){
				        	final double quantum = getEAT_AMOUNT() * 1.0;
				          	for (double x = getAssets().getAsset("Food").getQuantity(); x > 1.5*getTARGET_FOOD_STOCK(); x -= quantum) {
					            if(x == 0.0){
					            	x = .00000000001;
					            }
					            double mod = .1*Math.pow(getTARGET_FOOD_STOCK()/(x - getTARGET_FOOD_STOCK()), .2) +.90/*5*/+Random.uniform(0.0, 1.0)*getRANDOM_FACTOR();
					            double price = mod*getLastFoodPrice();
					            if (price <= 0.0){
					            	break;
					            }
					            
					            Offer o = new Offer();
					            o.setProduct("Food");
				            	o.setCurrency("Moeny");
				            	o.setQuantity(quantum);
				            	o.setPrice(price);
				            	o.setBuy(false);
				            	o.setAgentID(agentID);
				            	getSellList().getOffers().add(o);
				          }
				          //System.out.println("sellFood: " + getSellList().getOffers().size());
						return true;
						}
						return false;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="sellLabor" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the selloffers</dc:description>
					</documentation>
					<Parameter name="agentID" type="long"/>
					<Body language="Java"><![CDATA[
						double price;
						getSellList().getOffers().clear();
						if(getLastLaborPrice() > getLastFoodPrice() && getAssets().getAsset("Food").getQuantity() < getTARGET_FOOD_STOCK()){
				        	price = (getLastLaborPrice() - getLastFoodPrice()) * ((getAssets().getAsset("Food").getQuantity()*getAssets().getAsset("Food").getQuantity()) / (getTARGET_FOOD_STOCK()*getTARGET_FOOD_STOCK())) + getLastFoodPrice();
				          	price = Math.min(price, getLastLaborPrice()*1.1);
				        }else{
				            price = getLastLaborPrice();
				        }
				        final double frac = 0.95;
				        price *=((Math.max(Math.min(Random.normal(0.0, 1.0), 2.0),-2.0)/2)*(1 - frac) + 1);
				        Offer o = new Offer();
			            o.setProduct("Labor");
		            	o.setCurrency("Money");
		            	o.setQuantity(getLABOR_ALLOWANCE());
		            	o.setPrice(price);
		            	o.setBuy(false);
		            	o.setAgentID(agentID);
		            	getSellList().getOffers().add(o);
			            //System.out.println("sellLabor: "+ price);
			            return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="updateFood" resultType="Float">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Updates the foodamount by the quantity of the offer</dc:description>
					</documentation>
					<Parameter name="offer" type="Offer"/>
					<Body language="Java"><![CDATA[
						if(offer.isBuy()){
							getAssets().getAsset("Food").deposit(offer.getQuantity());
							//System.out.println("updateFood: " + getAssets().getAsset("Food").getQuantity() + " ||| PersonID: " + offer.getAgentID());
							return getFoodStock() + offer.getQuantity();						
						}else{
							getAssets().getAsset("Food").withdraw(offer.getQuantity());
							//System.out.println("updateFood: " + getAssets().getAsset("Food").getQuantity() + " ||| PersonID: " + offer.getAgentID());
							return getFoodStock() - offer.getQuantity();
						}
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="updateGold" resultType="Float">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Updates the goldamount by the quantity*price of the offer</dc:description>
					</documentation>
					<Parameter name="offer" type="Offer"/>
					<Body language="Java"><![CDATA[
						if(offer.isBuy()){
							getAssets().getAsset("Money").withdraw(offer.getQuantity()*offer.getPrice());
							//System.out.println("updateGold: " + getAssets().getAsset("Money").getQuantity());
							return (getGoldAmount() - (offer.getQuantity()*offer.getPrice()));						
						}else{
							getAssets().getAsset("Money").deposit(offer.getQuantity()*offer.getPrice());
							//System.out.println("updateGold: " + getAssets().getAsset("Money").getQuantity());
							return (getGoldAmount() + (offer.getQuantity()*offer.getPrice()));
						}
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<CommunicationRule name="StartOfDay_Rule" agentVariable="p">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>price is updated and decides to produce food or gold</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="StartOfDay_msg" messageVariable="msg"/>
					<IF language="Java">msg.getMarketType().equals("Food")</IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="lastFoodPrice">
								<ValueExpr language="Java">msg.getPrice()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</THEN>
					<ELSE>
						<UPDATE-AGT>
							<Slot property="lastLaborPrice">
								<ValueExpr language="Java">msg.getPrice()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</ELSE>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<CommunicationRule name="BuyFood_Rule" agentVariable="p">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<description> The person decides how much food he wants to buy</description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Act_msg"/>
					<IF language="Java">buyFood(p.getId())</IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="BuyFood_msg" receiverIdRefs="2">
								<Slot property="OfferList">
									<ValueExpr language="Java">getBuyList()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="SellFood_Rule" agentVariable="p">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<description> The person decides how much food he wants to sell</description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Act_msg"/>
					<IF language="Java">sellFood(p.getId())</IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="SellFood_msg" receiverIdRefs="2">
								<Slot property="OfferList">
									<ValueExpr language="Java">getSellList()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="SellLabor_Rule" agentVariable="p">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<description> The person decides how much labor he wants to sell</description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Act_msg"/>
					<IF language="Java">sellLabor(p.getId())</IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="SellLabor_msg" receiverIdRefs="3">
								<Slot property="OfferList">
									<ValueExpr language="Java">getSellList()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Update_Rule" agentVariable="p">	
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>succesfull transactions are receiverd from the market, food and gold is updated</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Transaction_msg" messageVariable="msg"/>
					<DO>
						<UPDATE-AGT>
							<Slot property="goldAmount">
								<ValueExpr language="Java">p.updateGold(msg.getOffer())</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</DO>
					<IF language="Java">msg.getOffer().getProduct().equals("Food")</IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="foodStock">
								<ValueExpr language="Java">p.updateFood(msg.getOffer())</ValueExpr>
							</Slot>					
						</UPDATE-AGT>
					</THEN>
				</CommunicationRule>
				
			</AgentType>
			<!-- ============================================ -->
			<AgentType name="Farm" superType="EconomicAgent">
				<!-- ============================================ -->
				<Attribute type="Float" name="TARGET_FOOD_STOCK" initialValue="120.0"/>
				<Attribute type="Float" name="TARGET_OWNER_FOOD_STOCK" initialValue="30.0"/>
				<Attribute type="Float" name="RANDOM_FACTOR" initialValue="0.01"/>
				<Attribute type="Float" name="lastFoodPrice"/>
				<Attribute type="Float" name="lastLaborPrice"/>
				<Attribute type="Float" name="foodproduced"/>
				<Attribute type="Float" name="foodStock"/>
				<Attribute type="Float" name="goldAmount"/>
				<ComplexDataProperty name="BuyList" type="OfferList"/>
				<ComplexDataProperty name="SellList" type="OfferList"/>
				<ComplexDataProperty name="owner" type="Person"/>
				
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="initializeOwnership" resultType="Person">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description></dc:description>
					</documentation>
					<Parameter name="owners" type="List"/>
					<Body language="Java"><![CDATA[
						Person person = null;
						for(Object o : owners){
							if((getOwner().getId() != ((Person)o).getId())&&(((Person)o).isOwner() == false)){
								person = (Person) o;
								((Person) o).setOwner(true);
								break;
							}
						}	
						return person;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="sellFood" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the selloffers and adds them to the sellofferlist</dc:description>
					</documentation>
					<Parameter name="agentID" type="long"/>
					<Body language="Java"><![CDATA[
						System.out.println("Food: " + getAssets().getAsset("Food").getQuantity() + " ||||| ID:   " + agentID);
						System.out.println("Money: " + getAssets().getAsset("Money").getQuantity() + " ||||| ID:   " + agentID);
						getSellList().getOffers().clear();
						if(getAssets().getAsset("Food").getQuantity()== 0){
							return false;
						}else{
							final double frac = 0.9;
            				double quantum = getAssets().getAsset("Food").getQuantity() / 10.0;
							for(double i = getAssets().getAsset("Food").getQuantity();i>0.0;i--){
                				double price = getLastFoodPrice()*((Math.max(Math.min(Random.normal(0.0, 1.0), 2.0),-2.0)/2)*(1 - frac) + 1);
                				Offer o = new Offer();
					            o.setProduct("Food");
				            	o.setCurrency("Money");
				            	o.setQuantity(quantum);
				            	o.setPrice(price);
				            	o.setBuy(false);
				            	o.setAgentID(agentID);
				            	getSellList().getOffers().add(o);
            				}
            			return true;
        				}
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="buyLabor" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the selloffers</dc:description>
					</documentation>
					<Parameter name="agentID" type="long"/>
					<Body language="Java"><![CDATA[
						getBuyList().getOffers().clear();
						double ownerFoodStock = getOwner().getAssets().getAsset("Food").getQuantity();
				        if(ownerFoodStock < .75*getTARGET_OWNER_FOOD_STOCK() && getAssets().getAsset("Food").getQuantity() < getTARGET_FOOD_STOCK()){
				        final double quantum = getLABOR_ALLOWANCE() * 1.0;
				          double purse = getAssets().getAsset("Money").getQuantity();
				          for (double x = ownerFoodStock; x <= 1.5 * getTARGET_OWNER_FOOD_STOCK(); x += quantum) {
				            if(x == 0.0) x = .00000000001;
				            double mod = .1*Math.pow(getTARGET_OWNER_FOOD_STOCK()/x, .2) +.90+Random.uniform(0.0, 1.0)*getRANDOM_FACTOR();
				            double price = mod*getLastLaborPrice();
				            price = Math.min(price, purse);
				            if (price <= 0.0) break;
				            purse -= quantum*price;
				            if(purse < 0.0) break;
				            
				            Offer o = new Offer();
				            o.setProduct("Labor");
			            	o.setCurrency("Money");
			            	o.setQuantity(quantum);
			            	o.setPrice(price);
			            	o.setBuy(true);
			            	o.setAgentID(agentID);
			            	getBuyList().getOffers().add(o);
			            	
				          }
				        }
						double lastProduct = 0.0, minPrice = (getLABOR_ALLOWANCE() * getLastLaborPrice()) / 2.0;
			            for (double d = getLABOR_ALLOWANCE(); getAssets().getAsset("Money").getQuantity() > 0.0; d += getLABOR_ALLOWANCE()) {
			                double marginalProduct = this.convertToFood(d) - lastProduct;
			
			                if (lastProduct + getAssets().getAsset("Food").getQuantity() >= getTARGET_FOOD_STOCK()) break;
			
			                double price = marginalProduct * getLastFoodPrice();
			
			                // stop when you'd be buying at < 1/2 the price of labor
			                if (price < minPrice) break;
			
			                Offer o = new Offer();
				            o.setProduct("Labor");
			            	o.setCurrency("Money");
			            	o.setQuantity(getLABOR_ALLOWANCE());
			            	o.setPrice(price);
			            	o.setBuy(true);
			            	o.setAgentID(agentID);
			            	getBuyList().getOffers().add(o);
			            	lastProduct += marginalProduct;
			            }
						return true;						
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="convertToFood" resultType="Float">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Calculates the selloffers</dc:description>
					</documentation>
					<Parameter name="laborQuantity" type="double"/>
					<Body language="Java"><![CDATA[
						return (-0.0652 * laborQuantity * laborQuantity) + 4.0652* laborQuantity;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="produceFood" resultType="Float">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Updates the laboramount by the quantity of the offer</dc:description>
					</documentation>
					<Parameter name="offer" type="Offer"/>
					<Body language="Java"><![CDATA[
							double food = convertToFood(offer.getQuantity());
							getAssets().getAsset("Food").deposit(food);
							//System.out.println("produceFood: " + getAssets().getAsset("Food").getQuantity());
							return getFoodproduced() + food;									
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="updateGold" resultType="Float">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Updates the goldamount by the quantity of the offer</dc:description>
					</documentation>
					<Parameter name="offer" type="Offer"/>
					<Body language="Java"><![CDATA[
						if(offer.isBuy()){
							getAssets().getAsset("Money").withdraw(offer.getQuantity()*offer.getPrice());
							//System.out.println("updateGold: " + getAssets().getAsset("Money").getQuantity());
							return (getGoldAmount() - (offer.getQuantity()*offer.getPrice()));						
						}else{
							getAssets().getAsset("Money").deposit(offer.getQuantity()*offer.getPrice());
							//System.out.println("updateGold: " + getAssets().getAsset("Money").getQuantity());
							return (getGoldAmount() + (offer.getQuantity()*offer.getPrice()));
						}
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<CommunicationRule name="StartOfDay_Rule" agentVariable="p">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>price is updated and decides to produce food or gold</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="StartOfDay_msg" messageVariable="msg"/>
					<IF language="Java">msg.getMarketType().equals("Food")</IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="lastFoodPrice">
								<ValueExpr language="Java">msg.getPrice()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</THEN>
					<ELSE>
						<UPDATE-AGT>
							<Slot property="lastLaborPrice">
								<ValueExpr language="Java">msg.getPrice()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</ELSE>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<CommunicationRule name="SellFood_Rule" agentVariable="f">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<description> The farm decides how much food he wants to sell</description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Act_msg"/>
					<IF language="Java">sellFood(f.getId())</IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="SellFood_msg" receiverIdRefs="2">
								<Slot property="OfferList">
									<ValueExpr language="Java">getSellList()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="BuyLabor_Rule" agentVariable="f">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<description> The person decides how much labor he wants to sell</description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Act_msg"/>
					<IF language="Java">buyLabor(f.getId())</IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="BuyLabor_msg" receiverIdRefs="3">
								<Slot property="OfferList">
									<ValueExpr language="Java">getBuyList()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Update_Rule" agentVariable="f">	
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>succesfull transactions are receiverd from the market, food and gold is updated</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Transaction_msg" messageVariable="msg"/>
					<DO>
						<UPDATE-AGT>
							<Slot property="goldAmount">
								<ValueExpr language="Java">f.updateGold(msg.getOffer())</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</DO>
					<IF language="Java">msg.getOffer().getProduct().equals("Food")</IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="foodStock">
								<ValueExpr language="Java">f.getAssets().getAsset("Food").withdraw(msg.getOffer().getQuantity())</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</THEN>
					<ELSE>
						<UPDATE-AGT>
							<Slot property="foodproduced">
								<ValueExpr language="Java">f.produceFood(msg.getOffer())</ValueExpr>
							</Slot>
						</UPDATE-AGT>
					</ELSE>
						
					
				</CommunicationRule>
			</AgentType>
			<AgentType name="Factory" superType="EconomicAgent">
				<Attribute type="Float" name="TARGET_UTILITY_STOCK" initialValue="60.0"/>
				
			</AgentType>
			<!-- ============================================ -->
			<AgentType name="Market">
				<!-- ============================================ -->
				<Attribute type="Float" name="marketPrice"/>
				<Attribute type="Float" name="marketVolume"/>
				<Attribute type="Float" name="buyVolume"/>
				<Attribute type="Float" name="sellVolume"/>
				<Attribute type="String" name="good"/>
				<ComplexDataProperty name="buyOffers" type="OfferList"/>
				<ComplexDataProperty name="sellOffers" type="OfferList"/>
				<ComplexDataProperty name="transactions" type="OfferList"/>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="clear" resultType="Boolean">
					<documentation>
						<dc:description>Calculates the marketprice and adds the corresponding buy- and selloffers to the transactionlist</dc:description>
					</documentation>
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<Body language="Java"><![CDATA[
						getTransactions().getOffers().clear();
						System.out.println("MarketType:" + getGood());
						System.out.println("BuyOffers:" + getBuyOffers().getOffers().size());
						System.out.println("SellOffers:" + getSellOffers().getOffers().size());
						// handle special cases
				        // highest buy price < lowest sell price -> no transactions OR
				        // empty offer list -> no transactions
				        if (getBuyOffers().isEmpty() || getSellOffers().isEmpty()) {
				        	// ToDO less
				        	getBuyOffers().getOffers().clear();
				        	getSellOffers().getOffers().clear();
				        	return false;
				        }
				        java.util.Comparator<Offer> comparator;
				        comparator = new java.util.Comparator<Offer>() {
							public int compare (Offer a, Offer b) {
							  double p1 = a.getPrice();
							  double p2 = b.getPrice(); 
								if(p1 < p2) return -1;
								if(p1 > p2) return 1;
								            return 0;	             		
							}		
						};
						
						java.util.Collections.shuffle(getBuyOffers().getOffers());
						java.util.Collections.shuffle(getSellOffers().getOffers());
						java.util.Collections.sort(getBuyOffers().getOffers(), comparator);
						java.util.Collections.sort(getSellOffers().getOffers(), comparator);
				        // merge prices into sorted list, eliminating duplicates
        				ArrayList<Double> prices = new ArrayList<Double>(getBuyOffers().getOffers().size() + getSellOffers().getOffers().size());
        				int s = 0, b = 0;
				        while (s < getSellOffers().getOffers().size() && b < getBuyOffers().getOffers().size()) {
				            if (equal(getSellOffers().getOffers().get(s).getPrice(), getBuyOffers().getOffers().get(b).getPrice())) {
				            	prices.add(getSellOffers().getOffers().get(s++).getPrice());
				                b++;
				            } else if(getSellOffers().getOffers().get(s).getPrice() < getBuyOffers().getOffers().get(b).getPrice()){
                				prices.add(getSellOffers().getOffers().get(s++).getPrice());
                			} else{
                				prices.add(getBuyOffers().getOffers().get(b++).getPrice());
                			}
                			// eliminate duplicates in sellOffers
				        	while (s < getSellOffers().getOffers().size() 
                    			   && equal(prices.get(prices.size() - 1), getSellOffers().getOffers().get(s).getPrice())){
                				s++;
							}
							 // eliminate duplicates in buyOffers
							while (b < getBuyOffers().getOffers().size()
                    			   && equal(prices.get(prices.size() - 1),getBuyOffers().getOffers().get(b).getPrice())){
                				b++;
                			}
                		}
                		// then add the remainder if there is one
        				if (s < getSellOffers().getOffers().size()){
           				 	while (s < getSellOffers().getOffers().size()) {
				                if (!equal(prices.get(prices.size() - 1), getSellOffers().getOffers().get(s).getPrice())){
				                	prices.add(getSellOffers().getOffers().get(s).getPrice());
				                }
				                s++;
			            	}
			            }else if (b < getBuyOffers().getOffers().size()){
            				while (b < getBuyOffers().getOffers().size()) {
				                if (!equal(prices.get(prices.size() - 1), getBuyOffers().getOffers().get(b).getPrice())){
				                    prices.add(getBuyOffers().getOffers().get(b).getPrice());
				                }
				                b++;
				            }
            			}
            			
            			// find the price(s) at which supply and demand intersect
				        double supply = 0, demand = 0;
				        // initialize demand to be the demand at lowest demand price
				        for (Offer o : getBuyOffers().getOffers()){
				            demand += o.getQuantity();
				            }
				        // walk through prices, updating supply and demand as needed.
				        int p = 0;
				        double bestVolume = Double.NEGATIVE_INFINITY;
				        int bestP = 0;
				        for (s = -1, b = 0; s + 1 < getSellOffers().getOffers().size() && b < getBuyOffers().getOffers().size(); p++) {
				            // if prices[p] is the next supply price:
				            while (s + 1 < getSellOffers().getOffers().size() && equal(prices.get(p), getSellOffers().getOffers().get(s +1 ).getPrice())){
				                supply += getSellOffers().getOffers().get(++s).getQuantity();
				            }
				            // if the current demand price is less than prices[p]:
				            while (b < getBuyOffers().getOffers().size() && less(getBuyOffers().getOffers().get(b).getPrice(), prices.get(p))){
				                demand -= getBuyOffers().getOffers().get(b++).getQuantity();
				            }
				            if (supply > demand) {
				                // volume = demand
				                if (demand > bestVolume) {
				                    bestVolume = demand;
				                    bestP = p;
				                }
				                break; // stop
				            } else if (supply > bestVolume) {
				            	// volume = supply here
				                bestVolume = supply;
				                bestP = p;
				            }
				        }
				        
			      	  	/*
				         * If the above loop broke because the final supply price was reached,
				         * then supply at Price >= prices[p-1] remains constant. Thus, it is
				         * necessary to check whether demand at higher prices will ever become
				         * less than the current supply. If so, then that will be at the market
				         * price.
				         */
				         if (s + 1 == getSellOffers().getOffers().size()) {
				            for (; b < getBuyOffers().getOffers().size() && p < prices.size(); p++) {
				                while (b < getBuyOffers().getOffers().size() && less(getBuyOffers().getOffers().get(b).getPrice(), prices.get(p)))
				                    demand -= getBuyOffers().getOffers().get(b++).getQuantity();
				
				                if (supply > demand) {
				                    // volume = demand
				                    if (demand > bestVolume) {
				                        bestVolume = demand;
				                        bestP = p;
				                    }
				                    break; // stop
				                } else if (supply > bestVolume) { 
				                	// volume = supply here
				                    bestVolume = supply;
				                    bestP = p;
				                }
				            }
				        }
				        
				        /*
				         * If one of the loops broke because the next price was greater than the
				         * highest demand price, then the market price is set to the highest
				         * demand price in order to minimize shortage.
				         */
				        if (b == getBuyOffers().getOffers().size()){
				            setMarketPrice(getBuyOffers().getOffers().get(b - 1).getPrice());
				        }
				        /* If supply never crosses demand, set to highest supply price */
				        else if (p == prices.size()){
				            setMarketPrice(getBuyOffers().getOffers().get(p -1 ).getPrice());
				        }
				        /*
				         * Finally, if the loop broke because supply > demand, there are two
				         * valid prices that could be the market price: prices[p], which is the
				         * smallest price at which supply tops demand, or prices[p-1], which is
				         * the largest price at which demand tops supply. Since either price is
				         * valid, we select between them in an arbitrary, yet deterministic
				         * manner. However, if choosing between a two prices, one of which would
				         * not cause any transactions to occur, we choose the other price.
				         */
				        else {
				            if (p == 0){
				                setMarketPrice(prices.get(p));
				            }else if (less(prices.get(p - 1), getSellOffers().getOffers().get(0).getPrice())){
				                setMarketPrice(prices.get(p));
				            }else if (less(getBuyOffers().getOffers().get(getBuyOffers().getOffers().size() - 1).getPrice(), prices.get(p))){
				                setMarketPrice(prices.get(p - 1));
				            }else {
				                setMarketPrice(prices.get(bestP));
				            }
				        }
				        int seller = 0, buyer = getBuyOffers().getOffers().size() - 1;
				        while (seller < getSellOffers().getOffers().size() && buyer >= 0
				                && !less(getMarketPrice(), getSellOffers().getOffers().get(seller).getPrice()) // sP <= mP
				                && !less(getBuyOffers().getOffers().get(buyer).getPrice(), getMarketPrice()))  // bP >= mP
						{				      
				            	getSellOffers().getOffers().get(seller).setPrice(getMarketPrice());
				            	getTransactions().getOffers().add(getSellOffers().getOffers().get(seller));
				                seller++;
				                getBuyOffers().getOffers().get(buyer).setPrice(getMarketPrice());
				            	getTransactions().getOffers().add(getBuyOffers().getOffers().get(buyer));
				                buyer--;
				        }
						// reset offer lists and set statistic variables
				        setMarketVolume(getTransactions().getOffers().size());
				        setBuyVolume(getBuyOffers().getOffers().size());
				        setSellVolume(getSellOffers().getOffers().size());
				        getBuyOffers().getOffers().clear();
				        getSellOffers().getOffers().clear();
				   		//System.out.println("MarketPrice:" + getMarketPrice());
				   		System.out.println("Transactions:" + getTransactions().getOffers().size());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="equal" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Check if the two Inputparameters are equal</dc:description>
					</documentation>
					<Parameter name="a" type="double"/>
					<Parameter name="b" type="double"/>
					<Body language="Java"><![CDATA[
						double eps = 1e-5;
						if (a + eps < b){
            				return false;
            			}
       					if (a - eps > b){
            				return false;
            			}
        				return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="less" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>checks if a less b </dc:description>
					</documentation>
					<Parameter name="a" type="double"/>
					<Parameter name="b" type="double"/>
					<Body language="Java"><![CDATA[
						double eps = 1e-5;
						if (a + eps < b){
				            return true;
				        }
				        return false;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="addBuyFood" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Adds the buyoffer to the buyofferlist</dc:description>
					</documentation>
					<Parameter name="offers" type="OfferList"/>
					<Body language="Java"><![CDATA[
						getBuyOffers().getOffers().addAll(offers.getOffers());
						//System.out.println("BuyOfferID: "+ offers.getOffers().get(0).getAgentID());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="addSellFood" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Adds the selloffer to the sellofferlist</dc:description>
					</documentation>
					<Parameter name="offers" type="OfferList"/>
					<Body language="Java"><![CDATA[
						getSellOffers().getOffers().addAll(offers.getOffers());
						//System.out.println("SellOfferID: " + offers.getOffers().get(0).getAgentID());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="addBuyLabor" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Adds the selloffer to the sellofferlist</dc:description>
					</documentation>
					<Parameter name="offers" type="OfferList"/>
					<Body language="Java"><![CDATA[
						getBuyOffers().getOffers().addAll(offers.getOffers());
						//System.out.println("SellOfferID: " + offers.getOffers().get(0).getAgentID());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
				<Function name="addSellLabor" resultType="Boolean">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
					<documentation>
						<dc:description>Adds the selloffer to the sellofferlist</dc:description>
					</documentation>
					<Parameter name="offers" type="OfferList"/>
					<Body language="Java"><![CDATA[
						getSellOffers().getOffers().addAll(offers.getOffers());
						//System.out.println("SellOfferID: " + offers.getOffers().get(0).getAgentID());
						return true;
					]]></Body>
				</Function>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Accept_BuyFood" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>BuyOffers are stored</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="BuyFood_msg" messageVariable="msg"/>
					<IF language="Java">m.addBuyFood(msg.getOfferList())</IF>
					<THEN></THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Accept_SellFood" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>SellOffers are stored</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="SellFood_msg" messageVariable="msg"/>
					<IF language="Java">m.addSellFood(msg.getOfferList())</IF>
					<THEN></THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Accept_BuyLabor" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>BuyOffers are stored</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="BuyLabor_msg" messageVariable="msg"/>
					<IF language="Java">m.addBuyLabor(msg.getOfferList())</IF>
					<THEN></THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Accept_SellLabor" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>SellOffers are stored</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="SellLabor_msg" messageVariable="msg"/>
					<IF language="Java">m.addSellLabor(msg.getOfferList())</IF>
					<THEN></THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Clear" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>The market gets cleared</dc:description>
					</documentation>
					<WHEN eventType="InMessageEvent" messageType="Clear_msg"/>
					<IF language="Java">m.clear()</IF>
					<THEN>
						<SCHEDULE-EVT>
							<ReminderEventExpr>
								<ReminderMsg language="Java">"transactions ready"</ReminderMsg>
							</ReminderEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>
				<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
				<CommunicationRule name="Transact" agentVariable="m">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<documentation>
						<dc:description>Done trades are reurned to the persons</dc:description>
					</documentation>
					<WHEN eventType="ReminderEvent" eventVariable="evt" />
					<FOR-ListItemVariable variable="o" listItemType="Offer">
						<ListExpr language="Java">getTransactions().getOffers()</ListExpr>
					</FOR-ListItemVariable>
					<IF language="Java"><![CDATA[evt.getReminderMsg().equals("transactions ready")]]></IF>
					<THEN>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="Transaction_msg">
								<ReceiverIdRef language="Java">o.getAgentID()</ReceiverIdRef>
								<Slot property="offer">
									<ValueExpr language="Java">o</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</CommunicationRule>	
			</AgentType>
		</EntityTypes>
		
	<EnvironmentRules>
		<!-- ============================= -->
		<EnvironmentRule name="InitializeOwnership">
			<!-- ============================= -->
			<WHEN eventType="Init"/>
			<FOR objectVariable="f" objectType="Farm" />
			<DO>
				<UPDATE-ENV>
					<UpdateObject objectVariable="f">
						<Slot property="owner">
							<ValueExpr language="Java">f.initializeOwnership(getEnvironmentSimulator().getObjectsByType(Person.class))</ValueExpr>
						</Slot>
					</UpdateObject>
				</UPDATE-ENV>
			</DO>
		</EnvironmentRule>
		<!-- ============================= -->
		<EnvironmentRule name="AtStartOfDayEat_ER">
			<!-- ============================= -->
			<documentation>
				<dc:description>Every person tries to eat, if he can't he dies</dc:description>
			</documentation>
			<WHEN eventType="StartOfDay" eventVariable="evt" />
			<FOR objectVariable="p" objectType="Person" />
			<IF language="Java"><![CDATA[
				p.getAssets().getAsset("Food").withdraw( p.getEAT_AMOUNT()) < p.getEAT_AMOUNT() 
			]]></IF>
			<THEN>
				<UPDATE-ENV>
					<DestroyObject objectVariable="p"/>
				</UPDATE-ENV>
			</THEN>
		</EnvironmentRule>
		<!-- ====================================== -->
		<EnvironmentRule name="StartOfDay_Rule_ER">
			<!-- ====================================== -->
			<documentation>
				<dc:description>For all markets that exist, the marketprice of the last day is send to every person</dc:description>
			</documentation>
			<WHEN eventType="StartOfDay"/>
			<FOR objectVariable="m" objectType="Market" />
			<FOR objectVariable="p" objectType="EconomicAgent" />
			<DO>
				<SCHEDULE-EVT>
					<InMessageEventExpr messageType="StartOfDay_msg">
					    <SenderIdRef language="Java">m.getId()</SenderIdRef>
						<ReceiverIdRef language="Java">p.getId()</ReceiverIdRef>
						<Slot property="price">
							<ValueExpr language="Java">m.getMarketPrice()</ValueExpr>
						</Slot>
						<Slot property="marketType">
							<ValueExpr language="Java">m.getGood()</ValueExpr>
						</Slot>
					</InMessageEventExpr>
				</SCHEDULE-EVT>
			</DO>
		</EnvironmentRule>
		
		<!-- ============================= -->
		<EnvironmentRule name="EachDayAt8AM_ER">
			<!-- ============================= -->
			<documentation>
				<dc:description>Act_msg is send to every person</dc:description>
			</documentation>
			<WHEN eventType="EachDayAt8AM"/>
			<FOR objectVariable="p" objectType="EconomicAgent" />
			<DO>
				<SCHEDULE-EVT>
					<InMessageEventExpr messageType="Act_msg" senderIdRef="0">
						<ReceiverIdRef language="Java">p.getId()</ReceiverIdRef>
					</InMessageEventExpr>
				</SCHEDULE-EVT>
			</DO>
		</EnvironmentRule>	
		<!-- ===================================== -->
		<EnvironmentRule name="EachDayAt11AM_ER">
		<!-- ===================================== -->
			<documentation>
				<dc:description>Clear_msg is send to every market</dc:description>
			</documentation>
			<WHEN eventType="EachDayAt11AM"/>
			<FOR objectVariable="m" objectType="Market" />
			<DO>
				<SCHEDULE-EVT>
					<InMessageEventExpr messageType="Clear_msg" senderIdRef="0">
						<ReceiverIdRef language="Java">m.getId()</ReceiverIdRef>
					</InMessageEventExpr>
				</SCHEDULE-EVT>
			</DO>
		</EnvironmentRule>
	</EnvironmentRules>	
		
	</SimulationModel>
	<!-- ======================= -->
	<InitialState>
	<!-- ======================= -->
		<Agent type="Market" id="2">
			<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->			
			<Slot property="marketPrice" value="2.0" />
			<Slot property="good" value="Food"></Slot>
		</Agent>
		<Agent type="Market" id="3">
			<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->			
			<Slot property="marketPrice" value="1.0" />
			<Slot property="good" value="Labor"></Slot>
		</Agent>
		<Agents type="Person" rangeStartID="1500" rangeEndID="1534">
			<Slot property="assets">
				<ValueExpr language="Java"><![CDATA[
					new AssetsList(){
				        {
				            addAsset(33.0d, "Food", "Stk");
				            addAsset(60.0d, "Money", "Stk");
				            addAsset(0.0d, "Labor", "Stk");
				        }
				    }
				]]></ValueExpr>
			</Slot>
			<Slot property="owner" value="false"></Slot>
			<Slot property="foodStock" value="33" />
			<Slot property="goldAmount" value="60" />
		</Agents>
		
		<Agents type="Farm" rangeStartID="1000" rangeEndID="1000">
			<Slot property="assets">
				<ValueExpr language="Java"><![CDATA[
					new AssetsList(){
				        {
				            addAsset(20.0d, "Food", "Stk");
				            addAsset(100.0d, "Money", "Stk");
				            addAsset(0.0d, "Labor", "Stk");
				        }
				    }
				]]></ValueExpr>
			</Slot>
			<Slot property="owner">
				<ValueExpr language="Java">new Person(-1, "", 1.0, 33.0, 60.0, 0.01, 0, 0, 33, 60, false, "", new OfferList(), new OfferList(), new AssetsList(), 1.0)</ValueExpr>
			</Slot>
			<Slot property="foodStock" value="20" />
			<Slot property="goldAmount" value="100" />
			<Slot property="skillLevelGold">
				<ValueExpr language="Java">0</ValueExpr>
			</Slot>
		</Agents>
		<ExogenousEvent type="Init" occurrenceTime="1" />
		<ExogenousEvent occurrenceTime="1" type="StartOfDay" />
		<ExogenousEvent occurrenceTime="8" type="EachDayAt8AM" />
		<ExogenousEvent occurrenceTime="11" type="EachDayAt11AM" />
	</InitialState>
	
	<!-- =================================================== -->
	<UserInterface>
		<StatisticsUI>
			<StatisticsVariableUI variable="PriceFood" comparisonGroup="pricevsfood">
				<Label>
					<Text xml:lang="en">FoodPrice</Text>
				</Label>
				<Hint>
					<Text xml:lang="en">What is the average market price?</Text>
				</Hint>
				<Format decimalPlaces="2">
					<Currency>EUR(&#8364;)</Currency>
				</Format>
			</StatisticsVariableUI>
			<StatisticsVariableUI variable="BuyOffersFood" comparisonGroup="pricevsfood">
				<Label>
					<Text xml:lang="en">number of BuyOffers</Text>
				</Label>
				<Hint>
					<Text xml:lang="en">What is the average market volume?</Text>
				</Hint>
			</StatisticsVariableUI>
			<StatisticsVariableUI variable="SellOffersFood" comparisonGroup="pricevsfood">
				<Label>
					<Text xml:lang="en">number of SellOffers</Text>
				</Label>
				<Hint>
					<Text xml:lang="en">What is the average market volume?</Text>
				</Hint>
			</StatisticsVariableUI>
			<StatisticsVariableUI variable="PriceLabor" comparisonGroup="pricevslabor">
				<Label>
					<Text xml:lang="en">LaborPrice</Text>
				</Label>
				<Hint>
					<Text xml:lang="en">What is the average market price?</Text>
				</Hint>
				<Format decimalPlaces="2">
					<Currency>EUR(&#8364;)</Currency>
				</Format>
			</StatisticsVariableUI>
			
		</StatisticsUI>
	</UserInterface>
</SimulationScenario>
