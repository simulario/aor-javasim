<?xml version="1.0" encoding="UTF-8"?>

<SimulationScenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://aor-simulation.org ../../../../../../AOR-JSim-Complete/AORSL/AORSL_0-8-4.xsd"
 xmlns:dc="http://purl.org/dc/elements/1.1/"
 xmlns="http://aor-simulation.org"
 xmlns:aors="http://aor-simulation.org"
 version="0.8.4"
 scenarioName="GunShot">
  <SimulationParameters simulationSteps="3000" timeUnit="ms" stepTimeDelay="5"/>

  <SimulationModel modelName="GunShot" modelTitle="Gun Shot with Gravitation Effect">
    <documentation>
      <dc:description>Emulate a gun shot by following Physics lows and using gravitation.</dc:description>
      <dc:creator>Mircea Diaconescu</dc:creator>
    </documentation>

    <SpaceModel geometry="Euclidean" spatialDistanceUnit="m">
      <TwoDimensional_LateralView xMax="15000" yMax="5000"/>
    </SpaceModel>

    <Statistics>
      <Variable name="maxHeight" dataType="Float" initialValue="0"/>
      <Variable name="height" dataType="Float">
        <Source>
          <ObjectProperty property="y" objectType="Bullet" objectIdRef="2"/>
        </Source>
      </Variable>
    </Statistics>

    <Globals>
      <GlobalVariable name="simluationSlowDownRatio" dataType="Float" minValue="1" maxValue="5"/>
      <GlobalVariable name="gravitation" dataType="Float"/>
      <GlobalVariable name="shotAngle" dataType="Float"/>
      <GlobalVariable name="startVelocity" dataType="Float"/>
      <GlobalVariable name="gunRectRadius" dataType="Float"/>
      <GlobalVariable name="gunRectCenterX" dataType="Float"/>
      <GlobalVariable name="gunRectCenterY" dataType="Float"/>
      <GlobalFunction name="getShotAngleInRadians" resultType="double">
        <Body language="Java">
          <![CDATA[
            return (Global.getShotAngle() * Math.PI) / 180;
          ]]>
        </Body>
        <Body language="JavaScript">
          <![CDATA[
            return (gunshot.controller.Global.getShotAngle() * Math.PI) / 180;
          ]]>
        </Body>
      </GlobalFunction>
      
    </Globals>


    <EntityTypes>
      <ExogenousEventType name="Shot" periodicity="1"/>
      <ExogenousEventType name="Step" periodicity="1"/>
      <PhysicalObjectType name="Bullet">
        <Attribute type="Float" name="distance"/>
        <Attribute type="Boolean" name="maxHeightReached" initialValue="false"/>
        <Attribute type="Boolean" name="vMaxSliderCreated" initialValue="false"/>
      </PhysicalObjectType>
      <PhysicalObjectType name="Gun"/>
      <PhysicalObjectType name="PathPoint"/>

      <PhysicalObjectType name="HorizontalBar"/>
      <PhysicalObjectType name="HorizontalSlider"/>

      <PhysicalObjectType name="VerticalBar"/>
      <PhysicalObjectType name="VerticalSlider"/>
    </EntityTypes>

    <EnvironmentRules>
      <EnvironmentRule name="ShotBulletRule">
        <WHEN eventType="Shot" eventVariable="shotEvent"/>
        <IF language="Java">shotEvent.getOccurrenceTime() == 1</IF>
        <IF language="JavaScript">this.shotEvent.getOccurrenceTime() == 1</IF>
        <THEN>
          <UPDATE-ENV>
            <Create>
              <PhysicalObject type="Bullet" id="2">
                <Slot property="distance" value="0"/>
                <Slot property="x">
                  <ValueExpr language="Java"><![CDATA[Global.getGunRectCenterX() + Global.getGunRectRadius() * Math.cos(Global.getShotAngleInRadians())]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[gunshot.controller.Global.getGunRectCenterX() + gunshot.controller.Global.getGunRectRadius() * Math.cos(gunshot.controller.Global.getShotAngleInRadians())]]></ValueExpr>
                </Slot>
                <Slot property="y">
                  <ValueExpr language="Java"><![CDATA[Global.getGunRectCenterY() + Global.getGunRectRadius() * Math.sin(Global.getShotAngleInRadians())]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[gunshot.controller.Global.getGunRectCenterY() + gunshot.controller.Global.getGunRectRadius() * Math.sin(gunshot.controller.Global.getShotAngleInRadians())]]></ValueExpr>
                </Slot>
                <Slot property="vx" value="100"/>
                <Slot property="width" value="300"/>
                <Slot property="height" value="300"/>
              </PhysicalObject>
            </Create>
          </UPDATE-ENV>
        </THEN>
      </EnvironmentRule>

      <EnvironmentRule name="MoveBulletRule">
        <WHEN eventType="Step" eventVariable="stepEvent"/>
        <FOR objectVariable="bullet" objectType="Bullet" objectIdRef="2"/>
        <FOR objectVariable="hSlider" objectType="HorizontalSlider" objectIdRef="101"/>
        <FOR objectVariable="vSlider" objectType="VerticalSlider" objectIdRef="201"/>
        <FOR dataVariable="currentTime" dataType="Float">
          <ValueExpr language="Java"><![CDATA[stepEvent.getOccurrenceTime()/Global.getSimluationSlowDownRatio()]]></ValueExpr>
          <ValueExpr language="JavaScript"><![CDATA[this.stepEvent.getOccurrenceTime()/gunshot.controller.Global.getSimluationSlowDownRatio()]]></ValueExpr>
        </FOR>
        <IF language="Java"><![CDATA[bullet.getY() - bullet.getHeight() / 2 > 0 ]]></IF>
        <IF language="JavaScript"><![CDATA[this.bullet.getY() - this.bullet.getHeight() / 2.0 > 0]]></IF>
        <THEN>
          <UPDATE-ENV>
            <UpdateObject objectVariable="bullet">
              <Slot property="distance">
                <ValueExpr language="Java"><![CDATA[bullet.getVx() * currentTime]]></ValueExpr>
                <ValueExpr language="JavaScript"><![CDATA[this.bullet.getVx() * this.currentTime]]></ValueExpr>
              </Slot>
              <Slot property="x">
                <ValueExpr language="Java">
                  <![CDATA[Global.getGunRectCenterX() + Global.getGunRectRadius() * Math.cos(Global.getShotAngleInRadians()) + Global.getStartVelocity() *  Math.cos(Global.getShotAngleInRadians()) * currentTime]]>
                </ValueExpr>

                <ValueExpr language="JavaScript">
                  <![CDATA[gunshot.controller.Global.getGunRectCenterX() + gunshot.controller.Global.getGunRectRadius() * Math.cos(gunshot.controller.Global.getShotAngleInRadians()) + gunshot.controller.Global.getStartVelocity() *  Math.cos(gunshot.controller.Global.getShotAngleInRadians()) * this.currentTime]]>
                </ValueExpr>
              </Slot>
              <Slot property="y">
                <ValueExpr language="Java">
                  <![CDATA[Global.getGunRectCenterY() + Global.getGunRectRadius() * Math.sin(Global.getShotAngleInRadians()) + Global.getStartVelocity() *  Math.sin(Global.getShotAngleInRadians()) * currentTime - (Global.getGravitation() / 2.0f) * currentTime * currentTime]]>
                </ValueExpr>

                <ValueExpr language="JavaScript">
                  <![CDATA[gunshot.controller.Global.getGunRectCenterY() + gunshot.controller.Global.getGunRectRadius() * Math.sin(gunshot.controller.Global.getShotAngleInRadians()) + gunshot.controller.Global.getStartVelocity() *  Math.sin(gunshot.controller.Global.getShotAngleInRadians()) * this.currentTime - (gunshot.controller.Global.getGravitation() / 2.0) * this.currentTime * this.currentTime]]>
                </ValueExpr>
              </Slot>
            </UpdateObject>

            <UpdateObject objectVariable="hSlider">
              <Slot property="x">
                <ValueExpr language="Java"><![CDATA[bullet.getX()]]></ValueExpr>
                <ValueExpr language="JavaScript"><![CDATA[this.bullet.getX()]]></ValueExpr>
              </Slot>
            </UpdateObject>

            <UpdateObject objectVariable="vSlider">
              <Slot property="y">
                <ValueExpr language="Java"><![CDATA[bullet.getY()]]></ValueExpr>
                <ValueExpr language="JavaScript"><![CDATA[this.bullet.getY()]]></ValueExpr>
              </Slot>
            </UpdateObject>
          </UPDATE-ENV>
        </THEN>
        <ELSE>
          <UPDATE-ENV>
            <UpdateObject objectVariable="bullet">
              <Slot property="y">
                <ValueExpr language="Java"><![CDATA[bullet.getHeight()/2]]></ValueExpr>
                <ValueExpr language="JavaScript"><![CDATA[this.bullet.getHeight()/2]]></ValueExpr>
              </Slot>
            </UpdateObject>
            <UpdateObject objectVariable="vSlider">
              <Slot property="y" value="0"/>
            </UpdateObject>
          </UPDATE-ENV>
          <SCHEDULE-EVT>
            <CausedEventExpr eventType="StopSimulationEvent"/>
          </SCHEDULE-EVT>
        </ELSE>
      </EnvironmentRule>

      <EnvironmentRule name="MaxHeightReachedRule">
        <WHEN eventType="Step" eventVariable="stepEvent"/>
        <FOR objectVariable="bullet" objectIdRef="2" objectType="Bullet"/>
        <IF language="Java"><![CDATA[SimStatistics.maxHeight.getValue() < bullet.getY()]]></IF>
        <IF language="JavaScript"><![CDATA[gunshot.controller.SimStatistics.maxHeight.getValue() < this.bullet.getY()]]></IF>
        <THEN>
          <UPDATE-ENV>
            <UpdateStatisticsVariable variable="maxHeight">
              <ValueExpr language="Java"><![CDATA[bullet.getY()]]></ValueExpr>
              <ValueExpr language="JavaScript"><![CDATA[this.bullet.getY()]]></ValueExpr>
            </UpdateStatisticsVariable>
          </UPDATE-ENV>
        </THEN>
        <ELSE>
          <UPDATE-ENV>
            <UpdateObject objectVariable="bullet">
              <Slot property="maxHeightReached" value="true"/>
            </UpdateObject>
          </UPDATE-ENV>
        </ELSE>
      </EnvironmentRule>

      <EnvironmentRule name="CreateMaxHeightSliderRule">
        <WHEN eventType="Step" eventVariable="stepEvent"/>
        <FOR objectVariable="bullet" objectIdRef="2" objectType="Bullet"/>
        <IF language="Java"><![CDATA[bullet.isMaxHeightReached() && !bullet.isVMaxSliderCreated()]]></IF>
        <IF language="JavaScript"><![CDATA[this.bullet.isMaxHeightReached()  && !this.bullet.isVMaxSliderCreated()]]></IF>
        <THEN>
          <UPDATE-ENV>
            <Create>
              <PhysicalObject type="VerticalSlider">
                <Slot property="x">
                  <ValueExpr language="Java"><![CDATA[bullet.getX()]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[this.bullet.getX()]]></ValueExpr>
                </Slot>
                <Slot property="y">
                  <ValueExpr language="Java"><![CDATA[bullet.getY()]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[this.bullet.getY()]]></ValueExpr>
                </Slot>
                <Slot property="width" value="500"/>
                <Slot property="height" value="40"/>
              </PhysicalObject>
            </Create>
            <UpdateObject objectVariable="bullet">
              <Slot property="vMaxSliderCreated" value="true"/>
            </UpdateObject>
          </UPDATE-ENV>
        </THEN>
      </EnvironmentRule>

      <EnvironmentRule name="DrawBulletPathRule">
        <WHEN eventType="Step" eventVariable="stepEvent"/>
        <FOR objectVariable="bullet" objectType="Bullet" objectIdRef="2"/>
        <IF language="Java"><![CDATA[stepEvent.getOccurrenceTime() % 5 == 0]]></IF>
        <IF language="JavaScript"><![CDATA[this.stepEvent.getOccurrenceTime() % 5 == 0]]></IF>
        <THEN>
          <UPDATE-ENV>
            <Create>
              <PhysicalObject type="PathPoint">
                <Slot property="x">
                  <ValueExpr language="Java"><![CDATA[bullet.getX()]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[this.bullet.getX()]]></ValueExpr>
                </Slot>
                <Slot property="y">
                  <ValueExpr language="Java"><![CDATA[bullet.getY()]]></ValueExpr>
                  <ValueExpr language="JavaScript"><![CDATA[this.bullet.getY()]]></ValueExpr>
                </Slot>
                <Slot property="width" value="30"/>
              </PhysicalObject>
            </Create>
          </UPDATE-ENV>
        </THEN>
      </EnvironmentRule>
    </EnvironmentRules>

  </SimulationModel>

  <InitialState>
    <GlobalVariable name="startVelocity" value="240"/>
    <GlobalVariable name="simluationSlowDownRatio" value="3"/>
    <GlobalVariable name="shotAngle" value="45"/>
    <GlobalVariable name="gunRectRadius" value="750"/>
    <GlobalVariable name="gunRectCenterX" value="750"/>
    <GlobalVariable name="gunRectCenterY" value="570"/>
    <GlobalVariable name="gravitation" value="9.81"/>
  
    
    <PhysicalObject type="Gun" id="1" x="750" y="570" width="1500" height="1140">
      <Slot property="rotZ">
        <ValueExpr language="Java"><![CDATA[Global.getShotAngle()]]></ValueExpr>
        <ValueExpr language="JavaScript"><![CDATA[gunshot.controller.Global.getShotAngle()]]></ValueExpr>
      </Slot>
    </PhysicalObject>

    <PhysicalObject type="HorizontalBar" id="100" x="7500" y="4500" z="1" width="15000" height="150"/>
    <PhysicalObject type="HorizontalSlider" id="101" y="4500" z="2" width="75" height="300">
      <Slot property="x">
        <ValueExpr language="Java"><![CDATA[Global.getGunRectCenterX() + Global.getGunRectRadius() * Math.cos(Global.getShotAngleInRadians())]]></ValueExpr>
        <ValueExpr language="JavaScript"><![CDATA[gunshot.controller.Global.getGunRectCenterX() + gunshot.controller.Global.getGunRectRadius() * Math.cos(gunshot.controller.Global.getShotAngleInRadians())]]></ValueExpr>
      </Slot>
    </PhysicalObject>

    <PhysicalObject type="VerticalBar" id="200" x="14500" z="1" y="2500" width="150" height="5000"/>
    <PhysicalObject type="VerticalSlider" id="201" x="14500" z="2" width="300" height="75">
      <Slot property="y">
        <ValueExpr language="Java"><![CDATA[Global.getGunRectCenterY() + Global.getGunRectRadius() * Math.sin(Global.getShotAngleInRadians())]]></ValueExpr>
        <ValueExpr language="JavaScript"><![CDATA[gunshot.controller.Global.getGunRectCenterY() + gunshot.controller.Global.getGunRectRadius() * Math.sin(gunshot.controller.Global.getShotAngleInRadians())]]></ValueExpr>
      </Slot>
    </PhysicalObject>

    <ExogenousEvent type="Shot" occurrenceTime="1"/>
    <ExogenousEvent type="Step" occurrenceTime="1"/>

   
  </InitialState>

  <UserInterface>
    <InitialStateUI>
      
      <GlobalVariableUI variable="simluationSlowDownRatio" widget="Slider" sliderStepSize="1">
        <Label>
          <Text>Slow Down Ratio</Text>
          <Text xml:lang="de">Verlangsamen Verhältnis</Text>
          <Text xml:lang="en">Slow Down Ratio</Text>
        </Label>
        <Hint>
          <Text>The ratio for slowing down the simulation</Text>
          <Text xml:lang="de">Das Verhältnis zur Verlangsamung der Simulation</Text>
          <Text xml:lang="en">The ratio for slowing down the simulation</Text>
        </Hint>
      </GlobalVariableUI>
      
      <GlobalVariableUI variable="startVelocity" widget="Slider" sliderStepSize="5">
        <Label>
          <Text>Velocity</Text>
          <Text xml:lang="de">Geschwindigkeit</Text>
          <Text xml:lang="en">Velocity</Text>
        </Label>
        <Hint>
          <Text>The shoot velocity of the bullet</Text>
          <Text xml:lang="de">Das Shooting Geschwindigkeit der Kugel</Text>
          <Text xml:lang="en">The shoot velocity of the bullet</Text>
        </Hint>
        <Unit>
          <Physics>m/s</Physics>
        </Unit>
      </GlobalVariableUI>
      
      <GlobalVariableUI variable="gravitation">
        <Label>
          <Text xml:lang="de">Gravitation</Text>
          <Text xml:lang="en">Gravitation</Text>
        </Label>
        <Hint>
          <Text>The gravitation in the environment</Text>
          <Text xml:lang="de">Die Gravitation in die Umwelt</Text>
          <Text xml:lang="en">The gravitation in the environment</Text>
        </Hint>
        <Unit>
          <Physics>m/s²</Physics>
        </Unit>
      </GlobalVariableUI>
      
      <GlobalVariableUI variable="shotAngle">
        <Label>
          <Text xml:lang="de">Schusswinkel</Text>
          <Text xml:lang="en">Shot Angle</Text>
        </Label>
        <Hint>
          <Text>The shot angle for the bullet</Text>
          <Text xml:lang="de">Der Schuss Winkel für die Kugel</Text>
          <Text xml:lang="en">The shot angle for the bullet</Text>
        </Hint>
        <Unit>
          <Math>°</Math>
        </Unit>
      </GlobalVariableUI>
      
    </InitialStateUI>
    
    <AnimationUI>
      <Views>
        <SpaceView canvasColorRGB="220 220 220">
          <TwoDimensionalSpaceView2D backgroundColor="lightgrey"/>
        </SpaceView>

        <PhysicalObjectView physicalObjectType="PathPoint">
          <PhysicalShape2D>
            <Circle fill="blue"/>
          </PhysicalShape2D>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectIdRef="1" physicalObjectType="Gun">
          <PhysicalShape2D>
            <Rectangle texture="cannon.png"/>
          </PhysicalShape2D>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectIdRef="2" physicalObjectType="Bullet">
          <PhysicalShape2D>
            <Rectangle texture="projectil.png"/>
          </PhysicalShape2D>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="HorizontalSlider">
          <PhysicalShape2D>
            <Rectangle fill="red" stroke="blue" strokeWidth="1"/>
          </PhysicalShape2D>
          <DisplayInfo property="x" content="m"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="HorizontalBar">
          <PhysicalShape2D>
            <Rectangle fill="white" stroke="blue" strokeWidth="1"/>
          </PhysicalShape2D>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="VerticalSlider">
          <PhysicalShape2D>
            <Rectangle fill="red" stroke="blue" strokeWidth="1"/>
          </PhysicalShape2D>
          <DisplayInfo property="y" content="m"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="VerticalBar">
          <PhysicalShape2D>
            <Rectangle fill="white" stroke="blue" strokeWidth="1"/>
          </PhysicalShape2D>
        </PhysicalObjectView>
      </Views>
    </AnimationUI>
  </UserInterface>
</SimulationScenario>
