<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="prettyprint.xsl"?>
<SimulationScenario xmlns="http://aor-simulation.org" xmlns:aors="http://aor-simulation.org" xmlns:dc="http://purl.org/dc/elements/1.1/"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://aor-simulation.org ../../AORSL/AORSL_0-8-4.xsd" version="0.8.4"
  scenarioName="CarsAndTrucksOnCircularTrack_2Cars_1Truck"
  scenarioTitle="A truck and two cars moving on a circular track with one speed
  limit sign for all and one speed limit sign only for trucks">

  <SimulationParameters simulationSteps="30000" stepDuration="100" timeUnit="ms" stepTimeDelay="30"/>

  <SimulationModel modelName="CarsAndTrucksOnCircularTrack" modelTitle="Cars and trucks moving on a circular track with uniform velocity" autoKinematics="true">
    <documentation>
      <dc:creator>Gerd Wagner</dc:creator>
      <dc:created>20080101</dc:created>
      <dc:description>
        This simulation models cars and trucks as special types of vehicle
        agents that move on a circular track and change their velocity in
        response to speed limit signs.
      </dc:description>
    </documentation>

    <SpaceModel geometry="Toroidal" spatialDistanceUnit="m">
      <OneDimensional xMax="20000"/>
    </SpaceModel>

    <EntityTypes>

      <!--MessageType name="Hello">
        <Attribute name="message" type="String"/>
      </MessageType-->

      <!-- The vehicle perceive its speed -->
      <!--PerceptionEventType name="UpdateVelocityBelief">
        <Attribute name="velocity" type="Float"/>
        </PerceptionEventType-->

      <!-- Vehicle speed up event -->
      <ActionEventType name="SpeedUp">
        <Attribute name="velocity" type="Integer"/>
      </ActionEventType>

      <!-- Vehicle slow down event -->
      <ActionEventType name="SlowDown">
        <Attribute name="velocity" type="Integer"/>
      </ActionEventType>

      <PhysicalObjectType name="SpeedLimitSign">
        <Attribute name="admMaxVelocity" type="Integer"/>
      </PhysicalObjectType>

      <PhysicalObjectType name="TruckSpeedLimitSign">
        <Attribute name="admMaxVelocity" type="Integer"/>
      </PhysicalObjectType>

      <PhysicalObjectType name="SpeedLimitCancelationSign"/>

      <!-- ========================== The vehicle agent ====================== -->
      <PhysicalAgentType name="Vehicle" autoPerception="true" memorySize="0">
        <SelfBeliefAttribute type="String" name="receivedMessage"/>
        <SelfBeliefAttribute name="maxVelocity" type="Integer"/>
        <SelfBeliefAttribute name="speedLimit" type="Integer" initialValue="0"/>
        <SelfBeliefAttribute name="myVelocity" type="Integer" initialValue="0"/>

        <ActionRule actionEventType="SlowDown" eventVariable="e" agentVariable="vehicle">
          <IF language="Java">
            <![CDATA[
              (vehicle.getMyVelocity() - e.getVelocity()) >= vehicle.getSpeedLimit()
            ]]>
          </IF>
          <THEN>
            <UPDATE-AGT>
              <SelfBeliefSlot property="myVelocity">
                <ValueExpr language="Java">vehicle.getMyVelocity() - e.getVelocity()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </THEN>
          <ELSE>
            <UPDATE-EVT>
              <Slot property="velocity">
                <ValueExpr language="Java">vehicle.getMyVelocity() - vehicle.getSpeedLimit()</ValueExpr>
              </Slot>
            </UPDATE-EVT>
            <UPDATE-AGT>
              <SelfBeliefSlot property="myVelocity">
                <ValueExpr language="Java">vehicle.getSpeedLimit()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </ELSE>
        </ActionRule>

        <ActionRule actionEventType="SpeedUp" eventVariable="e" agentVariable="vehicle">
          <IF language="Java">
            <![CDATA[
              (vehicle.getMyVelocity() + e.getVelocity()) <= vehicle.getMaxVelocity()
            ]]>
          </IF>
          <THEN>
            <UPDATE-AGT>
              <SelfBeliefSlot property="myVelocity">
                <ValueExpr language="Java">vehicle.getMyVelocity() + e.getVelocity()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </THEN>
          <ELSE>
            <UPDATE-EVT>
              <Slot property="velocity">
                <ValueExpr language="Java">vehicle.getMaxVelocity() - vehicle.getMyVelocity()</ValueExpr>
              </Slot>
            </UPDATE-EVT>
            <UPDATE-AGT>
              <SelfBeliefSlot property="myVelocity">
                <ValueExpr language="Java">vehicle.getMaxVelocity()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </ELSE>
        </ActionRule>

        <ReactionRule name="SlowDown_Rule" agentVariable="vehicle" useActionAndOutMessageRules="true">
          <documentation>
            <dc:description>
              Decrease the speed until the speed limit is reached.
            </dc:description>
          </documentation>
          <ON-EACH-SIMULATION-STEP/>
          <IF language="Java">
            <![CDATA[
              vehicle.getSpeedLimit() > 0 && vehicle.getMyVelocity() > vehicle.getSpeedLimit()
            ]]>
          </IF>
          <THEN>
            <SCHEDULE-EVT>
              <ActionEventExpr actionEventType="SlowDown">
                <Slot property="velocity" value="7"/>
              </ActionEventExpr>
            </SCHEDULE-EVT>
          </THEN>
        </ReactionRule>


        <ReactionRule name="SpeedUp_Rule" agentVariable="vehicle" useActionAndOutMessageRules="true">
          <documentation>
            <dc:description>
              No speed limit in this area, so increase the speed.
            </dc:description>
          </documentation>
          <ON-EACH-SIMULATION-STEP/>
          <IF language="Java">vehicle.getSpeedLimit() == 0</IF>
          <THEN>
            <SCHEDULE-EVT>
              <ActionEventExpr actionEventType="SpeedUp">
                <Slot property="velocity" value="7"/>
              </ActionEventExpr>
            </SCHEDULE-EVT>
          </THEN>
        </ReactionRule>

        <ReactionRule name="SpeedLimitStart_Rule" agentVariable="vehicle">
          <documentation>
            <dc:description>
              When a vehicle perceives a speed limit sign, it decreases its
              velocity to the admissible maximum velocity prescribed by the
              sign.
            </dc:description>
          </documentation>
          <WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="SpeedLimitSign" eventVariable="e"/>
          <DO>
            <UPDATE-AGT>
              <SelfBeliefSlot property="speedLimit">
                <ValueExpr language="Java">((SpeedLimitSign)e.getPerceivedPhysicalObject()).getAdmMaxVelocity()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </DO>
        </ReactionRule>

        <ReactionRule name="SpeedLimitEnd_Rule" agentVariable="vehicle">
          <documentation>
            <dc:description>
              When a vehicle perceives a speed limit cancelation sign, it
              increases its velocity until its maximum velocity.
            </dc:description>
          </documentation>
          <WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="SpeedLimitCancelationSign" eventVariable="e"/>
          <DO>
            <UPDATE-AGT>
              <SelfBeliefSlot property="speedLimit" value="0"/>
            </UPDATE-AGT>
          </DO>
        </ReactionRule>

        <!--ReactionRule name="ReceivedMessage_Rule" agentVariable="vehicle">
          <WHEN eventType="InMessageEvent" messageType="Hello" messageVariable="m"/>
          <DO>
            <UPDATE-AGT>
              <SelfBeliefSlot property="receivedMessage">
                <ValueExpr language="Java">m.getMessage()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </DO>
        </ReactionRule-->
      </PhysicalAgentType>

      <!-- ========================== The car agent ====================== -->
      <PhysicalAgentType name="Car" superType="Vehicle" autoPerception="true">
        <InitialAttributeValue attribute="perceptionRadius" value="50"/>
        <InitialAttributeValue attribute="width" value="10"/>
        <SelfBeliefAttribute type="String" name="sentMessage"/>
        <!--OutMessageRule messageType="Hello" messageVariable="m">
          <DO>
            <UPDATE-MSG>
              <Slot property="message">
                <ValueExpr language="Java">m.getMessage() + " Go Faster!"</ValueExpr>
              </Slot>
            </UPDATE-MSG>
            <UPDATE-AGT>
              <SelfBeliefSlot property="sentMessage">
                <ValueExpr language="Java">m.getMessage()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </DO>
        </OutMessageRule-->
        <!--ReactionRule name="SendMessageRule" agentVariable="car" useActionAndOutMessageRules="true">
          <WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="Vehicle" eventVariable="e"/>
          <DO>
            <SCHEDULE-EVT>
              <OutMessageEventExpr messageType="Hello">
                <ReceiverIdRef language="Java">e.getId()</ReceiverIdRef>
                <ReceiverIdRef language="JavaScript">this.e.getId()</ReceiverIdRef>
                <Slot property="message" value="Hello Friend!"/>
              </OutMessageEventExpr>
            </SCHEDULE-EVT>
          </DO>
        </ReactionRule-->      </PhysicalAgentType>

      <!-- ========================= The agent Truck ======================= -->
      <PhysicalAgentType name="Truck" superType="Vehicle" autoPerception="true">
        <!-- =================================================================== -->
        <InitialAttributeValue attribute="perceptionRadius" value="50"/>
        <InitialAttributeValue attribute="width" value="20"/>

        <ReactionRule name="TruckSpeedLimitStartPercEvtAgtRule" agentVariable="truck">
          <documentation>
            <dc:description>
              When a truck perceives a speed limit sign, it decreases its
              velocity to the admissible maximum velocity prescribed by the
              sign.
            </dc:description>
          </documentation>
          <WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="TruckSpeedLimitSign" eventVariable="e"/>
          <DO>
            <UPDATE-AGT>
              <SelfBeliefSlot property="speedLimit">
                <ValueExpr language="Java">((TruckSpeedLimitSign)e.getPerceivedPhysicalObject()).getAdmMaxVelocity()</ValueExpr>
              </SelfBeliefSlot>
            </UPDATE-AGT>
          </DO>
        </ReactionRule>
      </PhysicalAgentType>
    </EntityTypes>

    <!-- =================================================================== -->
    <EnvironmentRules>
      <EnvironmentRule name="SlowDownEnvRule">
        <documentation>
          <dc:description>
            When a vehicle agent has performed a SlowDown action, the
            environment simulator adjusts its velocity accordingly.
          </dc:description>
        </documentation>
        <WHEN eventType="SlowDown" eventVariable="e"/>
        <FOR objectType="Vehicle" objectVariable="vehicle">
          <ObjectRef language="Java">e.getActor()</ObjectRef>
        </FOR>
        <DO>
          <UPDATE-ENV>
            <UpdateObject objectVariable="vehicle">
              <Slot property="vx">
                <ValueExpr language="Java">vehicle.getVx() - e.getVelocity()</ValueExpr>
              </Slot>
            </UpdateObject>
          </UPDATE-ENV>
        </DO>
      </EnvironmentRule>

      <EnvironmentRule name="SpeedUpEnvRule">
        <documentation>
          <dc:description>
            When a vehicle agent has performed a SpeedUp action, the environment
            simulator adjusts its velocity accordingly.
          </dc:description>
        </documentation>
        <WHEN eventType="SpeedUp" eventVariable="e"/>
        <FOR objectType="Vehicle" objectVariable="vehicle">
          <ObjectRef language="Java">e.getActor()</ObjectRef>
        </FOR>
        <DO>
          <UPDATE-ENV>
            <UpdateObject objectVariable="vehicle">
              <Slot property="vx">
                <ValueExpr language="Java">vehicle.getVx() + e.getVelocity()</ValueExpr>
              </Slot>
            </UpdateObject>
          </UPDATE-ENV>
        </DO>
      </EnvironmentRule>
    </EnvironmentRules>
  </SimulationModel>

  <!-- ================================================================ -->
  <InitialState>
    <!-- ================================================================ -->
    <PhysicalAgent type="Car" name="Car1" id="1" x="1000" vx="0">
      <Slot property="width" value="180"/>
      <SelfBeliefSlot property="maxVelocity" value="150"/>
    </PhysicalAgent>

    <PhysicalAgent type="Car" name="Car2" id="2" x="500" vx="0">
      <Slot property="width" value="180"/>
      <SelfBeliefSlot property="maxVelocity" value="120"/>
    </PhysicalAgent>

    <PhysicalAgent type="Truck" name="Truck1" id="3" x="0" vx="0">
      <Slot property="width" value="230"/>
      <Slot property="height" value="230"/>
      <SelfBeliefSlot property="maxVelocity" value="100"/>
    </PhysicalAgent>

    <PhysicalObject type="SpeedLimitSign" name="SpeedLimitSign1" id="101" x="6000">
      <Slot property="admMaxVelocity" value="70"/>
      <Slot property="width" value="150"/>
    </PhysicalObject>

    <PhysicalObject type="TruckSpeedLimitSign" name="TruckSpeedLimitSign1" id="102" x="8000">
      <Slot property="admMaxVelocity" value="40"/>
      <Slot property="width" value="150"/>
    </PhysicalObject>

    <PhysicalObject type="SpeedLimitCancelationSign" name="SpeedLimitCancelationSign1" id="103" x="12000">
      <Slot property="width" value="150"/>
    </PhysicalObject>
  </InitialState>

  <UserInterface>
    <AnimationUI>
      <Views>
        <SpaceView canvasColor="darkgrey">
          <OneDimensionalSpaceView2D mode="circular"/>
        </SpaceView>

        <PhysicalObjectView physicalObjectType="Car">
          <PhysicalShape2D>
            <Circle fill="white" stroke="grey" strokeWidth="4"/>
          </PhysicalShape2D>
          <DisplayInfo property="vx" content="Km/h"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="Truck">
          <PhysicalShape2D>
            <Rectangle fill="grey" stroke="white" strokeWidth="6"/>
          </PhysicalShape2D>
          <DisplayInfo property="vx" content="Km/h"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="SpeedLimitSign">
          <PhysicalShape2D>
            <Circle fill="white" stroke="red" strokeWidth="4"/>
          </PhysicalShape2D>
          <DisplayInfo property="admMaxVelocity"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="TruckSpeedLimitSign">
          <PhysicalShape2D>
            <Circle fill="yellow" stroke="red" strokeWidth="4"/>
          </PhysicalShape2D>
          <DisplayInfo property="admMaxVelocity"/>
        </PhysicalObjectView>

        <PhysicalObjectView physicalObjectType="SpeedLimitCancelationSign">
          <PhysicalShape2D>
            <Circle fill="white" stroke="black" strokeWidth="4"/>
          </PhysicalShape2D>
        </PhysicalObjectView>

        <EventAppearance eventType="SlowDown" duration="600">
          <MidiSound instrumentNo="2" noteSequence="7/200 8/200 9/200"/>
          <MidiSound instrumentNo="17" noteSequence="2/150 4/150 6/150 8/150"/>
        </EventAppearance>

        <EventAppearance eventType="SpeedUp" duration="100">
          <MidiSound instrumentNo="6" noteSequence="7/200 8/200 9/200"/>
          <MidiSound instrumentNo="21" noteSequence="2/150 4/150 6/150 8/150"/>
        </EventAppearance>
      </Views>
      <AgentControlUI>
        <ControllableAgentType type="Car" suspendRules="SpeedUp_Rule SlowDown_Rule">
          <ControlInterface>
            <Style type="text/css">
              <![CDATA[     
               Structure {
                 /*	position:fixed;
                 	top:0;
                 	bottom:0;
                 	width:100%;
                 */	background-color:#EEEEEE;
               }
                 
                 div#visualization {
                 	position: fixed;
                 	top: 0;
                 	left: 0;
                 	width: 60%;
                 	bottom: 0;
                 	background-color: blue;
                 }
                 
                 visualization {
                 	display: block;
                 	position: absolute;
                 	top: 0;
                 	height: 100%;
                 	left: 0;
                 	width: 100%;
                 	border: 1px solid black;
                 	background-color: yellow;
                 }
                 
                 div#properties {
                 	position: fixed;
                 	top: 0;
                 	right: 0;
                 	width: 40%;
                 	bottom: 0;
                 }
                 
                 div#properties > * {
                 	margin: 5px;
                 }
                 
                 ul {
                 	display: block;
                 	margin: 0;
                 	padding: 0;
                 }
                 
                 li {
                 	position: relative;
                 	display: block;
                 	margin: 5px;
                 }
                 
                 label {
                 	display: inline-block;
                 	width: 30%;
                 }
                 
                 textfield, slider {
                 	display: inline-block;
                 	width: 60%;
                 	height: 1em;
                 }
	             ]]>
            </Style>
            <Structure>
							<h1>Properties</h1>
							<ul>
								<li>
									<label>speedLimit</label>
									<textfield slot="speedLimit" readonly="true" type="Integer"/>
								</li>
								<li>
									<label>maxVelocity</label>
									<textfield slot="maxVelocity" readonly="true" type="Integer"/>
								</li>
								<li>
									<label>myVelocity</label>
									<textfield slot="myVelocity" readonly="true" type="Integer"/>
								</li>
							</ul>
							<h1>Actions</h1>
							<ul>
								<li>
									<div>
										<label>modifySpeedBy</label>
										<slider slot="__speed" minValue="0" maxValue="10" initialValue="5" type="Integer"/>
										<textfield slot="__speed" initialValue="5" type="Integer"  name="speed"/>
									</div>
									<div>
										<button title="speedUp" name="SpeedUp"/>
										<button title="slowDown" name="SlowDown"/>
									</div>
								</li>
							</ul>
            </Structure>
          </ControlInterface>
          <InteractionRules>
            <InteractionRule name="SpeedUp" interfaceVariable="gui">
              <WHEN>
                <KeyboardEvent keyIdentifier="Up"/>
                <MouseEvent mouseEventType="click" targetType="SpeedUp"/>
              </WHEN>
              <DO>
                <SCHEDULE-EVT actionType="SpeedUp">
                  <Slot property="velocity">
                    <ValueExpr language="Java">gui.getSpeed()</ValueExpr>
                  </Slot>
                </SCHEDULE-EVT>
              </DO>
            </InteractionRule>
            <InteractionRule name="SlowDown" interfaceVariable="gui">
              <WHEN>
                <KeyboardEvent keyIdentifier="Down"/>
                <MouseEvent mouseEventType="click" targetType="SlowDown"/>
              </WHEN>
              <DO>
                <SCHEDULE-EVT actionType="SlowDown">
                  <Slot property="velocity">
                    <ValueExpr language="Java">gui.getSpeed()</ValueExpr>
                  </Slot>
                </SCHEDULE-EVT>
              </DO>
            </InteractionRule>
          </InteractionRules>
        </ControllableAgentType>
      </AgentControlUI>
    </AnimationUI>
  </UserInterface>
</SimulationScenario>
