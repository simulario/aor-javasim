<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="prettyprint.xsl"?>
<SimulationScenario
	xmlns="http://aor-simulation.org"
    xmlns:aors="http://aor-simulation.org"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://aor-simulation.org ../../../../../ext/aorsl/AORSL_0-9.xsd"
    version="0.9"
    simulationManagerDirectory="../../../../../"
	scenarioName="CarRacing"
	scenarioTitle="Car Racing">
	
	<SimulationParameters simulationSteps="10000" stepDuration="100" timeUnit="ms" stepTimeDelay="20"/>
	
	<SimulationModel modelName="CarRacing" modelTitle="Car Racing">
		<documentation>
            <dc:creator>Susanne Schoelzel</dc:creator>
            <dc:created>20120615</dc:created>
            <!--<description>
                This simulation models a car racing. (The overtaking does not work because the cars do not perceive cars on other tracks)
            </description>-->
        </documentation>
        
        <SpaceModel geometry="Toroidal" spatialDistanceUnit="m">
            <OneDimensional xMax="10000" multiplicity="4" autoKinematics="true"/>
        </SpaceModel>
		
		<EntityTypes>
			<ActionEventType name="ChangeLane">
				<Attribute name="newLane" type="Float" />
			</ActionEventType>
			
			<ActionEventType name="SetCarToOvertake">
				<Attribute name="newCarToOvertakeId" type="Integer" />
			</ActionEventType>
		
            <PhysicalAgentType name="Car">
				<ReferenceProperty name="carToOvertake" type="Car" />
				<Attribute name="perceivedCarId" type="Integer" />
			
				<ReactionRule name="OvertakeCar_Rule" agentVariable="car">
					<WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="Car" eventVariable="e" />
					<IF language="Java">
						<![CDATA[
							e.getPerceivedPhysicalObject().getY() == car.getY()+1 &&
							e.getPerceivedPhysicalObject().getVx() < car.getVx()
						]]>
					</IF>
                    <THEN>
						<UPDATE-AGT>
							<Slot property="perceivedCarId">
								<ValueExpr language="Java">e.getPerceivedPhysicalObjectIdRef()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
						<SCHEDULE-EVT>
                            <ActionEventExpr actionEventType="SetCarToOvertake">
								<Slot property="newCarToOvertakeId">
									<ValueExpr language="Java">e.getPerceivedPhysicalObjectIdRef()</ValueExpr>
								</Slot>
							</ActionEventExpr>
                        </SCHEDULE-EVT>
                    </THEN>
				</ReactionRule>
			
				<ReactionRule name="SwitchToOuterLane_Rule" agentVariable="car">
					<WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="Car" eventVariable="e" />
					<IF language="Java">
						<![CDATA[
							car.getY() != 1 &&
							e.getPerceivedPhysicalObject().getY() == car.getY() &&
							e.getPerceivedPhysicalObject().getVx() < car.getVx() &&
							e.getPerceptionAngle() == 0.0 &&
							e.getDistance() < 50
						]]>
					</IF>
                    <THEN>
						<UPDATE-AGT>
							<Slot property="perceivedCarId">
								<ValueExpr language="Java">e.getPerceivedPhysicalObjectIdRef()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
						<SCHEDULE-EVT>
                            <ActionEventExpr actionEventType="SetCarToOvertake">
								<Slot property="newCarToOvertakeId">
									<ValueExpr language="Java">e.getPerceivedPhysicalObjectIdRef()</ValueExpr>
								</Slot>
							</ActionEventExpr>
							<ActionEventExpr actionEventType="ChangeLane">
								<Slot property="newLane">
									<ValueExpr language="Java"><![CDATA[car.getY()+1]]></ValueExpr>
								</Slot>
							</ActionEventExpr>
                        </SCHEDULE-EVT>
                    </THEN>
				</ReactionRule>
				
				<ReactionRule name="SwitchToInnerLane_Rule" agentVariable="car">
					<WHEN eventType="PhysicalObjectPerceptionEvent" physicalObjectType="Car" eventVariable="e" />
					<IF language="Java">
						<![CDATA[
							car.getCarToOvertake().getId() == e.getPerceivedPhysicalObjectIdRef() &&
							car.getY() != 4 &&
							e.getDistance() > 50 &&
							e.getPerceptionAngle() > 160.0
						]]>
					</IF>
                    <THEN>
						<UPDATE-AGT>
							<Slot property="perceivedCarId">
								<ValueExpr language="Java">e.getPerceivedPhysicalObjectIdRef()</ValueExpr>
							</Slot>
						</UPDATE-AGT>
                        <SCHEDULE-EVT>
                            <ActionEventExpr actionEventType="ChangeLane">
								<Slot property="newLane">
									<ValueExpr language="Java"><![CDATA[car.getY()-1]]></ValueExpr>
								</Slot>
							</ActionEventExpr>
                        </SCHEDULE-EVT>
                    </THEN>
				</ReactionRule>
			</PhysicalAgentType>
        </EntityTypes>
		
		
		<EnvironmentRules>
			<EnvironmentRule name="ChangeLane_EnvRule">
				<WHEN eventType="ChangeLane" eventVariable="e"/>
				<FOR objectType="Car" objectVariable="car">
					<ObjectRef language="Java">e.getActor()</ObjectRef>
				</FOR>
				<DO>
					<UPDATE-ENV>
						<UpdateObject objectVariable="car">
							<Slot property="y">
								<ValueExpr language="Java">e.getNewLane()</ValueExpr>
							</Slot>
						</UpdateObject>
					</UPDATE-ENV>
				</DO>
			</EnvironmentRule>
			
			<EnvironmentRule name="SetCarToOvertake_EnvRule">
				<WHEN eventType="SetCarToOvertake" eventVariable="e"/>
				<FOR objectType="Car" objectVariable="car">
					<ObjectRef language="Java">e.getActor()</ObjectRef>
				</FOR>
				<FOR objectType="Car" objectVariable="newCarToOvertake">
					<ObjectIdRef language="Java">e.getNewCarToOvertakeId()</ObjectIdRef>
				</FOR>
				<DO>
					<UPDATE-ENV>
						<UpdateObject objectVariable="car">
							<Slot property="carToOvertake">
								<ObjectValueExpr objectVariable="newCarToOvertake" />
							</Slot>
						</UpdateObject>
					</UPDATE-ENV>
				</DO>
			</EnvironmentRule>

		</EnvironmentRules>
			
	</SimulationModel>
	<InitialState>
		<PhysicalAgent type="Car" id="1" name="Car1" perceptionRadius="1000">
			<Slot property="x" value="0"/>
			<Slot property="y" value="1"/>
			<Slot property="width" value="80"/>
			<Slot property="height" value="40"/>
			<Slot property="vx">
				<ValueExpr language="Java">100</ValueExpr>
			</Slot>
			<Slot property="perceivedCarId" value="0"/>
		</PhysicalAgent>
		<PhysicalAgent type="Car" id="2" name="Car2" perceptionRadius="1000">
			<Slot property="x" value="0"/>
			<Slot property="y" value="2"/>
			<Slot property="width" value="80"/>
			<Slot property="height" value="40"/>
			<Slot property="vx">
				<ValueExpr language="Java">100</ValueExpr>
			</Slot>
			<Slot property="perceivedCarId" value="0"/>
		</PhysicalAgent>
		<PhysicalAgent type="Car" id="3" name="Car3" perceptionRadius="1000">
			<Slot property="x" value="0"/>
			<Slot property="y" value="3"/>
			<Slot property="width" value="80"/>
			<Slot property="height" value="40"/>
			<Slot property="vx">
				<ValueExpr language="Java">100</ValueExpr>
			</Slot>
			<Slot property="perceivedCarId" value="0"/>
		</PhysicalAgent>
		<PhysicalAgent type="Car" id="4" name="Car4" perceptionRadius="1000">
			<Slot property="x" value="0"/>
			<Slot property="y" value="4"/>
			<Slot property="width" value="80"/>
			<Slot property="height" value="40"/>
			<Slot property="vx">
				<ValueExpr language="Java">100</ValueExpr>
			</Slot>
			<Slot property="perceivedCarId" value="0"/>
		</PhysicalAgent>
	</InitialState>
	<UserInterface supportedLanguages="">
		<AnimationUI>
            <Views>
                <SpaceView canvasColor="grey">
                    <OneDimensionalSpaceView3D mode="circular" trackWidth="30px" trackColor="grey">
                    	<Skybox top="backgrounds\\BlueSkyWithClouds.jpg" bottom="backgrounds\\BlueSkyWithClouds.jpg"
                    			left="backgrounds\\BlueSkyWithClouds.jpg" right="backgrounds\\BlueSkyWithClouds.jpg"
                    			front="backgrounds\\BlueSkyWithClouds.jpg" back="backgrounds\\BlueSkyWithClouds.jpg"/>
                  	</OneDimensionalSpaceView3D>
                </SpaceView>
                
                <PhysicalObjectView physicalObjectIdRef="1">
                    <PhysicalShape2D>
                        <Rectangle fill="yellow"/>
                    </PhysicalShape2D>
					<!--<DisplayInfo property="perceivedCarId" />-->
                </PhysicalObjectView>
                <PhysicalObjectView physicalObjectIdRef="2">
                    <PhysicalShape2D>
                        <Rectangle fill="red"/>
                    </PhysicalShape2D>
					<!--<DisplayInfo property="perceivedCarId" />-->
                </PhysicalObjectView>
                <PhysicalObjectView physicalObjectIdRef="3">
                    <PhysicalShape2D>
                        <Rectangle fill="green"/>
                    </PhysicalShape2D>
					<!--<DisplayInfo property="perceivedCarId" />-->
                </PhysicalObjectView>
                <PhysicalObjectView physicalObjectIdRef="4">
                    <PhysicalShape2D>
                        <Rectangle fill="blue"/>
                    </PhysicalShape2D>
					<!--<DisplayInfo property="perceivedCarId" />-->
                </PhysicalObjectView>
            </Views>
        </AnimationUI>
	</UserInterface>
</SimulationScenario>
